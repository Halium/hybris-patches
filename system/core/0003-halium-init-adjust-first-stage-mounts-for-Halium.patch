From 5f02b3ff5dba41dac9dc79a920bb7cd1ee63ff99 Mon Sep 17 00:00:00 2001
From: TheKit <nekit1000@gmail.com>
Date: Sat, 19 Dec 2020 21:39:09 +0200
Subject: [PATCH] (halium) init: adjust first stage mounts for Halium

Change-Id: I575e5f1072e69ffec9eea9adf96988f37f393018
Signed-off-by: Alexander Martinz <alex@amartinz.at>
---
 init/first_stage_init.cpp | 27 +++++++++++++++++++++------
 1 file changed, 21 insertions(+), 6 deletions(-)

diff --git a/init/first_stage_init.cpp b/init/first_stage_init.cpp
index 6b86e12f7..3bc336339 100644
--- a/init/first_stage_init.cpp
+++ b/init/first_stage_init.cpp
@@ -166,18 +166,33 @@ int FirstStageMain(int argc, char** argv) {
     // should be done in rc files.
     // Mount staging areas for devices managed by vold
     // See storage config details at http://source.android.com/devices/storage/
-    CHECKCALL(mount("tmpfs", "/mnt", "tmpfs", MS_NOEXEC | MS_NOSUID | MS_NODEV,
-                    "mode=0755,uid=0,gid=1000"));
+
+    // Disabled for Halium, mounted by LXC config
+    if (is_recovery) {
+        CHECKCALL(mount("tmpfs", "/mnt", "tmpfs", MS_NOEXEC | MS_NOSUID | MS_NODEV,
+                        "mode=0755,uid=0,gid=1000"));
+    }
     // /mnt/vendor is used to mount vendor-specific partitions that can not be
     // part of the vendor partition, e.g. because they are mounted read-write.
-    CHECKCALL(mkdir("/mnt/vendor", 0755));
+    if (is_recovery) {
+        CHECKCALL(mkdir("/mnt/vendor", 0755));
+    } else {
+        mkdir("/mnt/vendor", 0755);
+    }
     // /mnt/product is used to mount product-specific partitions that can not be
     // part of the product partition, e.g. because they are mounted read-write.
-    CHECKCALL(mkdir("/mnt/product", 0755));
+    if (is_recovery) {
+        CHECKCALL(mkdir("/mnt/product", 0755));
+    } else {
+        mkdir("/mnt/product", 0755);
+    }
 
     // /apex is used to mount APEXes
-    CHECKCALL(mount("tmpfs", "/apex", "tmpfs", MS_NOEXEC | MS_NOSUID | MS_NODEV,
-                    "mode=0755,uid=0,gid=0"));
+    // Disabled for Halium, mounted by LXC config
+    if (is_recovery) {
+        CHECKCALL(mount("tmpfs", "/apex", "tmpfs", MS_NOEXEC | MS_NOSUID | MS_NODEV,
+                        "mode=0755,uid=0,gid=0"));
+    }
 
     // /debug_ramdisk is used to preserve additional files from the debug ramdisk
     CHECKCALL(mount("tmpfs", "/debug_ramdisk", "tmpfs", MS_NOEXEC | MS_NOSUID | MS_NODEV,
-- 
2.32.0

